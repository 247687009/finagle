<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Client Stack &mdash; Finagle 6.10.0 documentation</title>
    
    <link rel="stylesheet" href="_static/finagle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '6.10.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Finagle 6.10.0 documentation" href="index.html" />
    <link rel="next" title="Metrics" href="Metrics.html" />
    <link rel="prev" title="Anatomy of a Client" href="ClientAnatomy.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="_static/small_flask.css" type= "text/css" rel="stylesheet" />

  </head>
  <body>
  
  

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Metrics.html" title="Metrics"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ClientAnatomy.html" title="Anatomy of a Client"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Finagle</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="client-stack">
<h1>Client Stack<a class="headerlink" href="#client-stack" title="Permalink to this headline">¶</a></h1>
<p>As of <a class="reference internal" href="changelog.html"><em>6.x</em></a>, the <a class="reference external" href="https://github.com/twitter/finagle/blob/master/finagle-core/src/main/scala/com/twitter/finagle/client/DefaultClient.scala">DefaultClient</a>
is the recommended api for building clients. The DefaultClient decorates a client
with many prominent components: load balancing over multiple hosts, connection
pooling per host, a failure management mechanism, and much more. Client implementations
are encouraged to provide sensible defaults and leave room
for application specific behavior to be built on top of the base
layer via filters or synchronization mechanisms.</p>
<div class="section" id="load-balancing">
<h2>Load Balancing<a class="headerlink" href="#load-balancing" title="Permalink to this headline">¶</a></h2>
<p id="heap-balancer">The heap balancer maintains a collection of hosts, each represented by a
ServiceFactory, and equally distributes requests over the hosts. The default
balancing strategy is to pick the host with the least number of outstanding requests,
which is similar to a least connections strategy in other load balancers. Additionally,
the load balancer deliberately introduces jitter to avoid synchronicity (and thundering herds)
in a distributed system and to ensure even balancing when request concurrency is low.</p>
<div class="section" id="minimumsetcluster">
<h3>MinimumSetCluster<a class="headerlink" href="#minimumsetcluster" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><strong>censored_add</strong></dt>
<dd>a counter of the number of times there is an attempt to add a server that is already in the
minimum set to the cluster</dd>
<dt><strong>censored_rem</strong></dt>
<dd>a counter of the number of times there is an attempt to remove a server that is guaranteed to be
in the minimum set to the cluster</dd>
<dt><strong>missing</strong></dt>
<dd>a gauge of the number of servers in the bag-difference between the supplementary cluster and the minimum set.
this should be the number of servers that would be missing if we only used the supplementary cluster</dd>
<dt><strong>additional</strong></dt>
<dd>a gauge of the number of servers in the bag-difference between the minimum set and the supplementary cluster.
this should be the number of servers that would be missing if we only used the minimum set</dd>
</dl>
</div>
<div class="section" id="heapbalancer">
<h3>HeapBalancer<a class="headerlink" href="#heapbalancer" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><strong>size</strong></dt>
<dd>a gauge of the number of nodes in the heap</dd>
<dt><strong>adds</strong></dt>
<dd>a counter of the number of adds to the heap</dd>
<dt><strong>removes</strong></dt>
<dd>a counter of the number of removes to the heap</dd>
<dt><strong>available</strong></dt>
<dd>a gauge of the number of available nodes in the heap</dd>
<dt><strong>load</strong></dt>
<dd>a gauge of the total load over all nodes in the heap</dd>
</dl>
</div>
</div>
<div class="section" id="connection-pooling">
<h2>Connection Pooling<a class="headerlink" href="#connection-pooling" title="Permalink to this headline">¶</a></h2>
<p id="watermark-pool">Finagle provides a generic pool that maintains a collection of
service instances. Each endpoint the client connects to has an independent
pool with high and low watermarks. The <a class="reference external" href="https://github.com/twitter/finagle/blob/master/finagle-core/src/main/scala/com/twitter/finagle/pool/WaterMarkPool.scala">WatermarkPool</a> keeps
persistent services up to the lower bound. It will keep making new services up
to upper bound if you checkout more than lower bound services, but when
you release those services above the lower bound, it immediately tries
to close them. This, however, creates a lot of connection churn if your
application consistantly requires more than lower bound connections.</p>
<p id="caching-pool">As a result, there is a separate facility for caching, with some TTL,
services above the lower bound. The <a class="reference external" href="https://github.com/twitter/finagle/blob/master/finagle-core/src/main/scala/com/twitter/finagle/pool/CachingPool.scala">CachingPool</a>
caches <em>regardless</em> of whether there are more than lower-bound open services;
it&#8217;s always caching up to (upper-bound - lower-bound) services. The cache reaches
its peak value when you reach your peak concurrency (i.e. &#8220;load&#8221;),
and then slowly decays, based on the TTL.</p>
<p>The DefaultClient layers both pools which amounts to
maintaining the low watermark (as long as request concurrency exists),
queueing requests above the high watermark, and applying a TTL for
services that are between [low, high].</p>
<div class="section" id="cachingpool">
<h3>CachingPool<a class="headerlink" href="#cachingpool" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><strong>pool_cached</strong></dt>
<dd>a gauge of the number of connections cached in the idle Cache</dd>
</dl>
</div>
<div class="section" id="watermarkpool">
<h3>WatermarkPool<a class="headerlink" href="#watermarkpool" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><strong>pool_waiters</strong></dt>
<dd>a gauge of the number of clients waiting on connections</dd>
<dt><strong>pool_size</strong></dt>
<dd>a gauge of the number of connections that are currently alive, either in use or not</dd>
</dl>
</div>
<div class="section" id="reusingpool">
<h3>ReusingPool<a class="headerlink" href="#reusingpool" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><strong>conn/fail</strong></dt>
<dd>a counter of the number of times the connection could not be established and must be retried</dd>
<dt><strong>conn/dead</strong></dt>
<dd>a counter of the number of times the connection succeeded once, but later died and must be retried</dd>
</dl>
</div>
</div>
<div class="section" id="fail-fast">
<h2>Fail Fast<a class="headerlink" href="#fail-fast" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/twitter/finagle/blob/master/finagle-core/src/main/scala/com/twitter/finagle/service/FailFastFactory.scala">FailFastFactory</a>
attempts to reduce the amount of requests dispatched to endpoints that are likely to fail.
It works by marking downed hosts when a connection fails, and launching a background process that
repeatedly attempts to reconnect with a given backoff schedule. During the time that a host is marked down,
the factory is marked unavailable (and thus the load balancer
above it will avoid its use). The factory becomes available
again on success or when the backoff schedule runs out.</p>
</div>
<div class="section" id="timeouts">
<h2>Timeouts<a class="headerlink" href="#timeouts" title="Permalink to this headline">¶</a></h2>
<p>Finagle provides timeout facilities with fine granularity. The simplest and most
common way to enforce a timeout is per-request using Future#within <a class="footnote-reference" href="#id2" id="id1">[1]</a>:</p>
<div class="highlight-text"><div class="highlight"><pre>val f = client(request)
f.within(1.seconds) onSuccess { ... } onFailure { ... }
</pre></div>
</div>
<p>The DefaultClient exposes parameters that enforce timeouts at varying
levels of the client stack:</p>
<p><strong>maxIdletime</strong> - The maximum time for which any Service is permitted to be idle.</p>
<p><strong>maxLifetime</strong> - The maximum lifetime for any Service.</p>
<p><strong>serviceTimeout</strong> - The maximum amount of time allowed for acquiring a Service.</p>
<p>By default these are disabled and DefaultClient implementations should
only enforced them with care.</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Future.within creates a new future that does not
cancel the original future if a timeout occurs.
When a timeout occurs, calling Future#raise
on the original future raises an advisory exception
and may potentially cancel a pending request.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="retries">
<h2>Retries<a class="headerlink" href="#retries" title="Permalink to this headline">¶</a></h2>
<p>Finagle provides a configurable <a class="reference external" href="https://github.com/twitter/finagle/blob/master/finagle-core/src/main/scala/com/twitter/finagle/service/RetryingFilter.scala">RetryingFilter</a>.
The filter can be configured either to retry a specific number of times or to adhere to a backoff strategy.
By default, the RetryingFilter <em>does not assume your RPC service is idempotent</em>. Retries occur only when they
are known to be safe. That is, when Finagle can guarantee the request was never delivered to the
server.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo" src="_static/governorlogo.png" alt="Logo"/>
</a></p><a href="index.html"><h3>Finagle</h3></a>
<p>
  Finagle is a network stack for distributed systems.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="http://github.com/twitter/finagle">Finagle @ GitHub</a></li>
  <li><a href="http://github.com/twitter/finagle/issues">Issue Tracker</a></li>
</ul>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Client Stack</a><ul>
<li><a class="reference internal" href="#load-balancing">Load Balancing</a><ul>
<li><a class="reference internal" href="#minimumsetcluster">MinimumSetCluster</a></li>
<li><a class="reference internal" href="#heapbalancer">HeapBalancer</a></li>
</ul>
</li>
<li><a class="reference internal" href="#connection-pooling">Connection Pooling</a><ul>
<li><a class="reference internal" href="#cachingpool">CachingPool</a></li>
<li><a class="reference internal" href="#watermarkpool">WatermarkPool</a></li>
<li><a class="reference internal" href="#reusingpool">ReusingPool</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fail-fast">Fail Fast</a></li>
<li><a class="reference internal" href="#timeouts">Timeouts</a></li>
<li><a class="reference internal" href="#retries">Retries</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="ClientAnatomy.html" title="previous chapter">Anatomy of a Client</a></li>
      <li>Next: <a href="Metrics.html" title="next chapter">Metrics</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2013 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  
  </body>
</html>